name: Security Scans

on:
  push:
    branches: ["master", "dev", "feature/*"]
  pull_request:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Проверка кода
        uses: actions/checkout@v4

      - name: Устанавливаем Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Устанавливаем зависимости проекта
        run: npm ci

      - name: Устанавливаем Snyk CLI
        run: npm install -g snyk

      - name: Запускаем npm audit
        run: npm audit --audit-level=high || true
        continue-on-error: true

      - name: Авторизуемся в Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk auth $SNYK_TOKEN

      - name: Запускаем Snyk Security Test
        continue-on-error: true
        run: |
          snyk test --json > snyk-report.json
          snyk test --json-file-output=snyk-report.json || true

      - name: Конвертируем в HTML
        run: |
          npx snyk-to-html -i snyk-report.json -o snyk-report.html

      - name: Выгружаем отчеты Snyk
        uses: actions/upload-artifact@v4
        with:
          name: snyk-reports
          path: |
            snyk-report.json
            snyk-report.html
